{% extends "film_site/index.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block one %}

<div class="container offer">
    <div class="row offer">
        <div class="col-md-12 offer-text ">
            <h1 class="mb-0 text-center">Заказ видеосъемки</h1>
        </div>
    </div>
</div>

<div class="razdel-2">
    <form class="container" id="buyer" action="{% url 'order' %}" method="post">
        {% csrf_token %}
        <div class="row align-self-center">
            <div class="col-md-12 mt-3">
                {{ form|crispy }}
                <div class="row align-self-center justify-content-end">
                    <div class="row col-md-6">
                        <input id="calc" class='btn btn-primary' type="submit" value="Посчитать стоимость съемки" />
                        <h4 class="mx-4 my-0 align-self-center">Цена: <span id="price">0</span> рублей</h3>
                    </div>
                </div>
                <input class='btn btn-primary' id="buy" type="submit" value="ЗАКАЗАТЬ" disabled/>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}

<script>

    // csrf токен берется тут
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $("#calc").click(function (e) {
        e.preventDefault();

        var form = $("#buyer"); 

        $.ajax({
            headers: {
                "X-CSRFToken": csrftoken
            },
            type: 'POST',
            url: "{% url 'order' %}calc",
            data: form.serialize(),
            dataType: "json",
            success: function (response) {
                
                console.log(response.data)
                $("#price").text(response.data);
                $("#buy").prop("disabled", false);
            },
            error: function (response) {
                
                alert('Проверьте правильность введенных данных!')
                console.log(response.data)

            }
        });
    });
</script>

{% endblock %}